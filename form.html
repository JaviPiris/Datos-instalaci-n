<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Datos de Instalación</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Color de fondo suave */
        }
        /* Estilo para campos readonly */
        input[readonly], select[readonly] {
            background-color: #e2e8f0; /* bg-gray-200 */
            cursor: not-allowed;
        }
        /* Estilo para campos con error */
        input.input-error, select.input-error {
            border-color: #ef4444; /* Rojo - border-red-500 */
            box-shadow: 0 0 0 1px #ef4444;
        }
        /* Estilo para mensajes de error */
        .error-message {
            color: #ef4444; /* Rojo - text-red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-10 border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 text-center">Datos de Instalación</h1>
        <p class="text-gray-600 mb-8 text-center">Por favor, rellena todos los campos requeridos para la instalación.</p>

        <form id="installationForm">
            <!-- Sección: Dirección completa de instalación -->
            <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Dirección Completa de Instalación</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tipoVia" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Vía</label>
                        <select id="tipoVia" name="tipoVia" required
                                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                            <option value="">Selecciona</option>
                            <option value="calle">Calle</option>
                            <option value="avenida">Avenida</option>
                            <option value="plaza">Plaza</option>
                            <option value="paseo">Paseo</option>
                            <option value="carretera">Carretera</option>
                            <option value="via">Vía</option>
                            <option value="ronda">Ronda</option>
                            <option value="bulevar">Bulevar</option>
                            <option value="camino">Camino</option>
                            <option value="urbanizacion">Urbanización</option>
                            <option value="glorieta">Glorieta</option>
                            <option value="pasaje">Pasaje</option>
                            <option value="rambla">Rambla</option>
                            <option value="travesia">Travesía</option>
                            <option value="cuesta">Cuesta</option>
                            <option value="barrio">Barrio</option>
                            <option value="poligono">Polígono Industrial</option>
                        </select>
                        <div id="tipoViaError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="nombreVia" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Vía</label>
                        <input type="text" id="nombreVia" name="nombreVia" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div id="nombreViaError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">Número</label>
                        <input type="text" id="numero" name="numero" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div id="numeroError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="bloquePortal" class="block text-sm font-medium text-gray-700 mb-1">Bloque / Portal</label>
                        <input type="text" id="bloquePortal" name="bloquePortal"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div id="bloquePortalError" class="error-message hidden"></div>
                    </div>
                    <!-- Campo para Código Postal -->
                    <div>
                        <label for="codigoPostal" class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
                        <input type="text" id="codigoPostal" name="codigoPostal" required maxlength="5" pattern="[0-9]{5}" title="Introduce un código postal de 5 dígitos"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div id="codigoPostalError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="poblacionLocalidad" class="block text-sm font-medium text-gray-700 mb-1">Población / Localidad</label>
                        <input type="text" id="poblacionLocalidad" name="poblacionLocalidad" required readonly
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <div id="poblacionLocalidadError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="provincia" class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
                        <select id="provincia" name="provincia" required readonly
                                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                            <option value="">Selecciona una provincia</option>
                            <option value="Alava">Álava</option>
                            <option value="Albacete">Albacete</option>
                            <option value="Alicante">Alicante</option>
                            <option value="Almeria">Almería</option>
                            <option value="Asturias">Asturias</option>
                            <option value="Avila">Ávila</option>
                            <option value="Badajoz">Badajoz</option>
                            <option value="Barcelona">Barcelona</option>
                            <option value="Burgos">Burgos</option>
                            <option value="Caceres">Cáceres</option>
                            <option value="Cadiz">Cádiz</option>
                            <option value="Cantabria">Cantabria</option>
                            <option value="Castellon">Castellón</option>
                            <option value="Ciudad Real">Ciudad Real</option>
                            <option value="Cordoba">Córdoba</option>
                            <option value="Cuenca">Cuenca</option>
                            <option value="Gerona">Gerona</option>
                            <option value="Granada">Granada</option>
                            <option value="Guadalajara">Guadalajara</option>
                            <option value="Guipuzcoa">Guipúzcoa</option>
                            <option value="Huelva">Huelva</option>
                            <option value="Huesca">Huesca</option>
                            <option value="Islas Baleares">Islas Baleares</option>
                            <option value="Jaen">Jaén</option>
                            <option value="La Coruna">La Coruña</option>
                            <option value="La Rioja">La Rioja</option>
                            <option value="Las Palmas">Las Palmas</option>
                            <option value="Leon">León</option>
                            <option value="Lerida">Lérida</option>
                            <option value="Lugo">Lugo</option>
                            <option value="Madrid">Madrid</option>
                            <option value="Malaga">Málaga</option>
                            <option value="Murcia">Murcia</option>
                            <option value="Navarra">Navarra</option>
                            <option value="Orense">Orense</option>
                            <option value="Palencia">Palencia</option>
                            <option value="Pontevedra">Pontevedra</option>
                            <option value="Salamanca">Salamanca</option>
                            <option value="Santa Cruz de Tenerife">Santa Cruz de Tenerife</option>
                            <option value="Segovia">Segovia</option>
                            <option value="Sevilla">Sevilla</option>
                            <option value="Soria">Soria</option>
                            <option value="Tarragona">Tarragona</option>
                            <option value="Teruel">Teruel</option>
                            <option value="Toledo">Toledo</option>
                            <option value="Valencia">Valencia</option>
                            <option value="Valladolid">Valladolid</option>
                            <option value="Vizcaya">Vizcaya</option>
                            <option value="Zamora">Zamora</option>
                            <option value="Zaragoza">Zaragoza</option>
                        </select>
                        <div id="provinciaError" class="error-message hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Sección: Datos de la comunidad de propietarios / empresa -->
            <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-2xl font-semibold text-green-700 mb-4">Datos de la Comunidad de Propietarios / Empresa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="denominacionNombre" class="block text-sm font-medium text-gray-700 mb-1">Denominación / Nombre (presidente)</label>
                        <input type="text" id="denominacionNombre" name="denominacionNombre" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        <div id="denominacionNombreError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="cif" class="block text-sm font-medium text-gray-700 mb-1">C.I.F.</label>
                        <!-- Validación CIF/NIF básico: 1 letra, 7-8 dígitos, 1 letra/dígito final -->
                        <input type="text" id="cif" name="cif" pattern="^[XYZxyz]?[0-9]{7}[A-HJ-NP-TV-Z]$|^[A-HJ-NP-TV-Z][0-9]{7}[A-Z0-9]$" title="Formato CIF/NIF: ej. A12345678, X12345678"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm uppercase">
                        <div id="cifError" class="error-message hidden"></div>
                    </div>
                    <!-- NUEVO CAMPO: Teléfono de la Comunidad/Empresa (Obligatorio) -->
                    <div>
                        <label for="tlfComunidad" class="block text-sm font-medium text-gray-700 mb-1">Nº de Teléfono</label>
                        <input type="tel" id="tlfComunidad" name="tlfComunidad" required pattern="^(\+34|0034)?[6789]\d{8}$" title="Formato de teléfono: 9 dígitos (ej. 6XXXXXXXX) o con +34"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        <div id="tlfComunidadError" class="error-message hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Sección: Datos de contacto a efectos administrativos y de facturación -->
            <div class="mb-8 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Datos de Contacto (Administrativos y Facturación)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="contactoAAFF" class="block text-sm font-medium text-gray-700 mb-1">AAFF o Persona de Contacto</label>
                        <input type="text" id="contactoAAFF" name="contactoAAFF"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        <div id="contactoAAFFError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="emailContacto" class="block text-sm font-medium text-gray-700 mb-1">Email de Contacto</label>
                        <input type="email" id="emailContacto" name="emailContacto"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        <div id="emailContactoError" class="error-message hidden"></div>
                    </div>
                    <!-- CAMPO MODIFICADO: Teléfono de Contacto (AHORA OPCIONAL) -->
                    <div>
                        <label for="tlfContacto" class="block text-sm font-medium text-gray-700 mb-1">Nº de Teléfono de Contacto</label>
                        <input type="tel" id="tlfContacto" name="tlfContacto" pattern="^(\+34|0034)?[6789]\d{8}$" title="Formato de teléfono: 9 dígitos (ej. 6XXXXXXXX) o con +34"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        <div id="tlfContactoError" class="error-message hidden"></div>
                    </div>
                </div>
                <!-- Campos detallados de la dirección de contacto -->
                <div class="mt-6 p-4 bg-yellow-100 rounded-md border border-yellow-300">
                    <h3 class="lg font-medium text-yellow-800 mb-3">Dirección Completa de Contacto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contactoTipoVia" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Vía (Contacto)</label>
                            <select id="contactoTipoVia" name="contactoTipoVia"
                                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                                <option value="">Selecciona</option>
                                <option value="calle">Calle</option>
                                <option value="avenida">Avenida</option>
                                <option value="plaza">Plaza</option>
                                <option value="paseo">Paseo</option>
                                <option value="carretera">Carretera</option>
                                <option value="via">Vía</option>
                                <option value="ronda">Ronda</option>
                                <option value="bulevar">Bulevar</option>
                                <option value="camino">Camino</option>
                                <option value="urbanizacion">Urbanización</option>
                                <option value="glorieta">Glorieta</option>
                                <option value="pasaje">Pasaje</option>
                                <option value="rambla">Rambla</option>
                                <option value="travesia">Travesía</option>
                                <option value="cuesta">Cuesta</option>
                                <option value="barrio">Barrio</option>
                                <option value="poligono">Polígono Industrial</option>
                            </select>
                            <div id="contactoTipoViaError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="contactoNombreVia" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Vía (Contacto)</label>
                            <input type="text" id="contactoNombreVia" name="contactoNombreVia"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="contactoNombreViaError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="contactoNumero" class="block text-sm font-medium text-gray-700 mb-1">Número (Contacto)</label>
                            <input type="text" id="contactoNumero" name="contactoNumero"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="contactoNumeroError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="contactoBloquePortal" class="block text-sm font-medium text-gray-700 mb-1">Bloque / Portal (Contacto)</label>
                            <input type="text" id="contactoBloquePortal" name="contactoBloquePortal"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="contactoBloquePortalError" class="error-message hidden"></div>
                        </div>
                        <!-- Campo para Código Postal (Contacto) -->
                        <div>
                            <label for="contactoCodigoPostal" class="block text-sm font-medium text-gray-700 mb-1">Código Postal (Contacto)</label>
                            <input type="text" id="contactoCodigoPostal" name="contactoCodigoPostal" maxlength="5" pattern="[0-9]{5}" title="Introduce un código postal de 5 dígitos"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="contactoCodigoPostalError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="contactoPoblacionLocalidad" class="block text-sm font-medium text-gray-700 mb-1">Población / Localidad (Contacto)</label>
                            <input type="text" id="contactoPoblacionLocalidad" name="contactoPoblacionLocalidad" readonly
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="contactoPoblacionLocalidadError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="contactoProvincia" class="block text-sm font-medium text-gray-700 mb-1">Provincia (Contacto)</label>
                            <select id="contactoProvincia" name="contactoProvincia" readonly
                                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                                <option value="">Selecciona una provincia</option>
                                <option value="Alava">Álava</option>
                                <option value="Albacete">Albacete</option>
                                <option value="Alicante">Alicante</option>
                                <option value="Almeria">Almería</option>
                                <option value="Asturias">Asturias</option>
                                <option value="Avila">Ávila</option>
                                <option value="Badajoz">Badajoz</option>
                                <option value="Barcelona">Barcelona</option>
                                <option value="Burgos">Burgos</option>
                                <option value="Caceres">Cáceres</option>
                                <option value="Cadiz">Cádiz</option>
                                <option value="Cantabria">Cantabria</option>
                                <option value="Castellon">Castellón</option>
                                <option value="Ciudad Real">Ciudad Real</option>
                                <option value="Cordoba">Córdoba</option>
                                <option value="Cuenca">Cuenca</option>
                                <option value="Gerona">Gerona</option>
                                <option value="Granada">Granada</option>
                                <option value="Guadalajara">Guadalajara</option>
                                <option value="Guipuzcoa">Guipúzcoa</option>
                                <option value="Huelva">Huelva</option>
                                <option value="Huesca">Huesca</option>
                                <option value="Islas Baleares">Islas Baleares</option>
                                <option value="Jaen">Jaén</option>
                                <option value="La Coruna">La Coruña</option>
                                <option value="La Rioja">La Rioja</option>
                                <option value="Las Palmas">Las Palmas</option>
                                <option value="Leon">León</option>
                                <option value="Lerida">Lérida</option>
                                <option value="Lugo">Lugo</option>
                                <option value="Madrid">Madrid</option>
                                <option value="Malaga">Málaga</option>
                                <option value="Murcia">Murcia</option>
                                <option value="Navarra">Navarra</option>
                                <option value="Orense">Orense</option>
                                <option value="Palencia">Palencia</option>
                                <option value="Pontevedra">Pontevedra</option>
                                <option value="Salamanca">Salamanca</option>
                                <option value="Santa Cruz de Tenerife">Santa Cruz de Tenerife</option>
                                <option value="Segovia">Segovia</option>
                                <option value="Sevilla">Sevilla</option>
                                <option value="Soria">Soria</option>
                                <option value="Tarragona">Tarragona</option>
                                <option value="Teruel">Teruel</option>
                                <option value="Toledo">Toledo</option>
                                <option value="Valencia">Valencia</option>
                                <option value="Valladolid">Valladolid</option>
                                <option value="Vizcaya">Vizcaya</option>
                                <option value="Zamora">Zamora</option>
                                <option value="Zaragoza">Zaragoza</option>
                            </select>
                            <div id="contactoProvinciaError" class="error-message hidden"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-yellow-100 rounded-md border border-yellow-300">
                    <h3 class="lg font-medium text-yellow-800 mb-3">Datos Bancarios (SEPA)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="titularCuenta" class="block text-sm font-medium text-gray-700 mb-1">Titular de la Cuenta</label>
                            <input type="text" id="titularCuenta" name="titularCuenta"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="titularCuentaError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="banco" class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
                            <input type="text" id="banco" name="banco"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                            <div id="bancoError" class="error-message hidden"></div>
                        </div>
                        <div>
                            <label for="iban" class="block text-sm font-medium text-gray-700 mb-1">IBAN</label>
                            <!-- Validación IBAN España: ES + 2 dígitos + 20 alfanuméricos -->
                            <input type="text" id="iban" name="iban" pattern="^[A-Z]{2}[0-9]{2}(?:[ ]?[0-9]{4}){4}(?:[ ]?[0-9]{2})?$" title="Formato IBAN: ESXX XXXX XXXX XXXX XXXX XXXX (con o sin espacios)"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm placeholder-gray-400"
                                   placeholder="ESXX XXXX XXXX XXXX XXXX XXXX">
                            <div id="ibanError" class="error-message hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Datos del instalador y fecha de instalación -->
            <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200">
                <h2 class="text-2xl font-semibold text-purple-700 mb-4">Información del Instalador y Cita</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tlfInstalador" class="block text-sm font-medium text-gray-700 mb-1">Nº de Teléfono del Instalador</label>
                        <!-- Validación para número de teléfono español (9 dígitos, opcionalmente con prefijo +34) -->
                        <input type="tel" id="tlfInstalador" name="tlfInstalador" pattern="^(\+34|0034)?[6789]\d{8}$" title="Formato de teléfono: 9 dígitos (ej. 6XXXXXXXX) o con +34"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                        <div id="tlfInstaladorError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="fechaInstalacion" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Instalación</label>
                        <input type="date" id="fechaInstalacion" name="fechaInstalacion"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                        <div id="fechaInstalacionError" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label for="horaInstalacion" class="block text-sm font-medium text-gray-700 mb-1">Hora de Instalación</label>
                        <input type="time" id="horaInstalacion" name="horaInstalacion"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                        <div id="horaInstalacionError" class="error-message hidden"></div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="flex items-center">
                            <!-- Checkbox ya no es obligatorio -->
                            <input id="normoApp" name="normoApp" type="checkbox"
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <label for="normoApp" class="ml-2 block text-sm font-medium text-gray-700">El instalador se ha descargado y registrado en la app de Normo</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área para mostrar mensajes de confirmación o error -->
            <div id="formMessage" class="mt-4 p-3 rounded-md text-center hidden"></div>

            <!-- Botón de Envío -->
            <div class="mt-10 text-center">
                <button type="submit"
                        class="inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-lg font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105">
                    Enviar Formulario
                </button>
            </div>
        </form>
    </div>

    <script>
        // ¡IMPORTANTE! Reemplaza esta URL con la URL de tu Web App de Google Apps Script
        const GOOGLE_APP_SCRIPT_URL = 'URL_DE_TU_WEB_APP_DE_GOOGLE_APPS_SCRIPT'; 

        const form = document.getElementById('installationForm');
        const formMessage = document.getElementById('formMessage');

        // Referencias a los campos de Código Postal y sus respectivos campos de Población/Provincia
        const codigoPostalInput = document.getElementById('codigoPostal');
        const poblacionLocalidadInput = document.getElementById('poblacionLocalidad');
        const provinciaSelect = document.getElementById('provincia');

        const contactoCodigoPostalInput = document.getElementById('contactoCodigoPostal');
        const contactoPoblacionLocalidadInput = document.getElementById('contactoPoblacionLocalidad');
        const contactoProvinciaSelect = document.getElementById('contactoProvincia');

        /**
         * Función para obtener datos de población y provincia por código postal usando Nominatim.
         * @param {string} postalCode - El código postal de 5 dígitos.
         * @returns {Promise<Object>} - Un objeto con { success: boolean, ciudad: string, provincia: string, message: string }
         */
        async function fetchPostalCodeData(postalCode) {
            // URL de la API de Nominatim para buscar por código postal y país (España)
            // Se usa "es" para el lenguaje de la respuesta.
            const NOMINATIM_URL = `https://nominatim.openstreetmap.org/search?postalcode=${postalCode}&country=Spain&format=json&addressdetails=1&limit=1&accept-language=es`;
            
            try {
                const response = await fetch(NOMINATIM_URL, {
                    headers: {
                        // User-Agent es requerido por Nominatim para un uso adecuado
                        // Reemplaza 'tu-email@ejemplo.com' con un email real o un identificador único
                        'User-Agent': 'FormularioInstalacionApp/1.0 (tu-email@ejemplo.com)' 
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0].address;
                    let ciudad = '';
                    let provincia = '';

                    ciudad = result.city || result.town || result.village || result.county;
                    provincia = result.province; 

                    const provinceMapping = {
                        'comunidad de madrid': 'Madrid',
                        'comunitat valenciana': 'Valencia',
                        'cataluña': 'Barcelona',
                        'andalucía': 'Sevilla',
                        'país vasco': 'Vizcaya', 
                        'castilla y león': 'Valladolid', 
                        'castilla-la mancha': 'Toledo', 
                        'galicia': 'La Coruna', 
                        'aragón': 'Zaragoza', 
                        'canarias': 'Las Palmas', 
                        'murcia': 'Murcia', 
                        'extremadura': 'Badajoz', 
                        'navarra': 'Navarra', 
                        'cantabria': 'Cantabria', 
                        'princ. de asturias': 'Asturias', 
                        'baleares': 'Islas Baleares', 
                        'la rioja': 'La Rioja', 
                        'ceuta': 'Ceuta', 
                        'melilla': 'Melilla' 
                    };

                    const normalizeText = (text) => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
                    const normalizedProvincia = normalizeText(provincia);

                    if (provinceMapping[normalizedProvincia]) {
                        provincia = provinceMapping[normalizedProvincia];
                    } else {
                        provincia = provincia.charAt(0).toUpperCase() + provincia.slice(1);
                    }

                    if (ciudad && provincia) {
                        return { success: true, ciudad: ciudad, provincia: provincia };
                    } else {
                        return { success: false, message: 'Datos de población/provincia incompletos para este CP.' };
                    }
                } else {
                    return { success: false, message: 'Código postal no encontrado en España.' };
                }
            } catch (error) {
                console.error('Error al consultar la API de Nominatim:', error);
                return { success: false, message: 'Error al conectar con el servicio de códigos postales. Intenta de nuevo más tarde.' };
            }
        }

        /**
         * Autocompleta los campos de población y provincia basándose en el código postal.
         * @param {HTMLElement} postalCodeInput - El input del código postal.
         * @param {HTMLElement} poblacionInput - El input de la población/localidad.
         * @param {HTMLElement} provinciaSelect - El select de la provincia.
         * @param {HTMLElement} errorElementCP - El div de error asociado al CP.
         * @param {HTMLElement} errorElementPoblacion - El div de error asociado a la población.
         * @param {HTMLElement} errorElementProvincia - El div de error asociado a la provincia.
         */
        async function autocompleteAddress(postalCodeInput, poblacionInput, provinciaSelect, errorElementCP, errorElementPoblacion, errorElementProvincia) {
            const postalCode = postalCodeInput.value.trim();

            // Limpia mensajes de error previos
            errorElementCP.classList.add('hidden');
            errorElementPoblacion.classList.add('hidden');
            errorElementProvincia.classList.add('hidden');
            postalCodeInput.classList.remove('input-error');
            poblacionInput.classList.remove('input-error');
            provinciaSelect.classList.remove('input-error');

            // Solo buscar si el CP tiene 5 dígitos y es numérico
            if (postalCode.length === 5 && /^[0-9]{5}$/.test(postalCode)) {
                // Deshabilitar campos mientras se busca
                poblacionInput.readOnly = true;
                provinciaSelect.readOnly = true;
                poblacionInput.value = 'Buscando...';
                provinciaSelect.value = ''; // Limpiar select antes de buscar

                try {
                    const data = await fetchPostalCodeData(postalCode); 
                    if (data.success) {
                        poblacionInput.value = data.ciudad;
                        
                        // Normalizar el nombre de provincia de la API para la comparación
                        const normalizedDataProvincia = data.provincia.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

                        let optionFound = false;
                        Array.from(provinciaSelect.options).forEach(option => {
                            const normalizedOption = option.value.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                            if (normalizedOption === normalizedDataProvincia) {
                                provinciaSelect.value = option.value; // Establece el valor exacto de la opción
                                optionFound = true;
                            }
                        });
                        
                        if (!optionFound) {
                            console.warn(`Provincia '${data.provincia}' obtenida de la API no encontrada en la lista de opciones del select.`);
                            provinciaSelect.value = ''; // Si no se encuentra una coincidencia exacta, se queda la opción por defecto o vacía
                        }
                        
                        // Mantener los campos como readonly si se encontró el CP y se autocompletó
                        poblacionInput.readOnly = true; 
                        provinciaSelect.readOnly = true; 
                        formMessage.classList.add('hidden'); // Ocultar mensaje general si la búsqueda fue exitosa
                        
                    } else {
                        // Si la búsqueda no fue exitosa
                        poblacionInput.value = '';
                        provinciaSelect.value = '';
                        poblacionInput.readOnly = false; // Habilitar para entrada manual
                        provinciaSelect.readOnly = false; // Habilitar para entrada manual

                        // Mostrar mensaje de error en la UI (en el div de error del CP)
                        errorElementCP.textContent = data.message;
                        errorElementCP.classList.remove('hidden');
                        postalCodeInput.classList.add('input-error');

                        formMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700');
                        formMessage.classList.add('bg-orange-100', 'text-orange-700');
                        formMessage.textContent = "Error de autocompletado para el Código Postal: " + data.message;
                        formMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error general al obtener datos del código postal:', error);
                    poblacionInput.value = '';
                    provinciaSelect.value = '';
                    poblacionInput.readOnly = false; // Habilitar para entrada manual
                    provinciaSelect.readOnly = false; // Habilitar para entrada manual

                    errorElementCP.textContent = 'Error de conexión con el servicio de CP.';
                    errorElementCP.classList.remove('hidden');
                    postalCodeInput.classList.add('input-error');

                    formMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700');
                    formMessage.classList.add('bg-red-100', 'text-red-700');
                    formMessage.textContent = 'Error de red o servicio de CP. Por favor, inténtalo de nuevo o rellena manualmente.';
                    formMessage.classList.remove('hidden');
                }
            } else {
                // Si el CP no es válido o está vacío
                poblacionInput.value = '';
                provinciaSelect.value = '';
                poblacionInput.readOnly = false; // Habilitar para entrada manual
                provinciaSelect.readOnly = false; // Habilitar para entrada manual
                
                // Si el campo es requerido, mostrar error aquí
                if (postalCodeInput.hasAttribute('required') && postalCode.length === 0) {
                    errorElementCP.textContent = 'Este campo es obligatorio.';
                    errorElementCP.classList.remove('hidden');
                    postalCodeInput.classList.add('input-error');
                } else if (postalCode.length > 0 && postalCode.length !== 5) {
                     errorElementCP.textContent = 'El Código Postal debe tener 5 dígitos.';
                    errorElementCP.classList.remove('hidden');
                    postalCodeInput.classList.add('input-error');
                } else if (postalCode.length > 0 && !/^[0-9]{5}$/.test(postalCode)) {
                    errorElementCP.textContent = 'El Código Postal solo debe contener números.';
                    errorElementCP.classList.remove('hidden');
                    postalCodeInput.classList.add('input-error');
                }
                formMessage.classList.add('hidden'); // Ocultar mensaje general si el CP es corto/inválido
            }
        }


        // Event listener para el envío del formulario
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Previene el envío tradicional del formulario

            let formIsValid = true;

            // Validar todos los campos antes de enviar
            // Dirección de Instalación (obligatorios)
            formIsValid = validateField(document.getElementById('tipoVia'), document.getElementById('tipoViaError'), 'Por favor, selecciona un tipo de vía.') && formIsValid;
            formIsValid = validateField(document.getElementById('nombreVia'), document.getElementById('nombreViaError'), 'Introduce el nombre de la vía.') && formIsValid;
            formIsValid = validateField(document.getElementById('numero'), document.getElementById('numeroError'), 'Introduce el número.') && formIsValid;
            formIsValid = validateField(document.getElementById('codigoPostal'), document.getElementById('codigoPostalError'), 'Introduce un código postal válido (5 dígitos).') && formIsValid;
            formIsValid = validateField(document.getElementById('poblacionLocalidad'), document.getElementById('poblacionLocalidadError'), 'La población es obligatoria y debe ser autocompletada o rellenada manualmente.') && formIsValid;
            formIsValid = validateField(document.getElementById('provincia'), document.getElementById('provinciaError'), 'La provincia es obligatoria y debe ser autocompletada o seleccionada manualmente.') && formIsValid;
            
            // Campos opcionales de Dirección de Instalación que aún pueden tener validación de patrón si se rellenan
            formIsValid = validateField(document.getElementById('bloquePortal'), document.getElementById('bloquePortalError'), 'Introduce el bloque/portal.') && formIsValid;


            // Datos de la Comunidad/Empresa (obligatorios)
            formIsValid = validateField(document.getElementById('denominacionNombre'), document.getElementById('denominacionNombreError'), 'Introduce la denominación o nombre.') && formIsValid;
            formIsValid = validateField(document.getElementById('tlfComunidad'), document.getElementById('tlfComunidadError'), 'Introduce un número de teléfono de la comunidad válido.') && formIsValid; // NUEVO CAMPO OBLIGATORIO
            // CIF es opcional ahora, pero se valida si se introduce
            formIsValid = validateField(document.getElementById('cif'), document.getElementById('cifError'), 'Introduce un CIF/NIF válido (ej. A12345678).') && formIsValid;

            // Datos de Contacto (Administrativos y Facturación)
            formIsValid = validateField(document.getElementById('contactoAAFF'), document.getElementById('contactoAAFFError'), 'Introduce la persona de contacto.') && formIsValid;
            formIsValid = validateField(document.getElementById('emailContacto'), document.getElementById('emailContactoError'), 'Introduce un email válido.') && formIsValid;
            // tlfContacto ahora es opcional
            formIsValid = validateField(document.getElementById('tlfContacto'), document.getElementById('tlfContactoError'), 'Introduce un número de teléfono de contacto válido (9 dígitos o con prefijo +34).') && formIsValid; 

            // Dirección Completa de Contacto (todos opcionales, pero se validan si se rellenan)
            formIsValid = validateField(document.getElementById('contactoTipoVia'), document.getElementById('contactoTipoViaError'), 'Por favor, selecciona un tipo de vía de contacto.') && formIsValid;
            formIsValid = validateField(document.getElementById('contactoNombreVia'), document.getElementById('contactoNombreViaError'), 'Introduce el nombre de la vía de contacto.') && formIsValid;
            formIsValid = validateField(document.getElementById('contactoNumero'), document.getElementById('contactoNumeroError'), 'Introduce el número de contacto.') && formIsValid;
            formIsValid = validateField(document.getElementById('contactoBloquePortal'), document.getElementById('contactoBloquePortalError'), 'Introduce el bloque/portal de contacto.') && formIsValid;
            formIsValid = validateField(document.getElementById('contactoCodigoPostal'), document.getElementById('contactoCodigoPostalError'), 'Introduce un código postal de contacto válido (5 dígitos).') && formIsValid;
            formIsValid = validateField(document.getElementById('contactoPoblacionLocalidad'), document.getElementById('contactoPoblacionLocalidadError'), 'La población de contacto es obligatoria si se ingresa CP.') && formIsValid;
            formIsValid = validateField(document.getElementById('contactoProvincia'), document.getElementById('contactoProvinciaError'), 'La provincia de contacto es obligatoria si se ingresa CP.') && formIsValid;

            // Datos Bancarios (todos opcionales, pero se validan si se rellenan)
            formIsValid = validateField(document.getElementById('titularCuenta'), document.getElementById('titularCuentaError'), 'Introduce el titular de la cuenta.') && formIsValid;
            formIsValid = validateField(document.getElementById('banco'), document.getElementById('bancoError'), 'Introduce el nombre del banco.') && formIsValid;
            formIsValid = validateField(document.getElementById('iban'), document.getElementById('ibanError'), 'Introduce un IBAN válido (ej. ESXX XXXX XXXX XXXX XXXX XXXX).') && formIsValid;

            // Datos del Instalador y Cita (todos opcionales, pero se validan si se rellenan)
            formIsValid = validateField(document.getElementById('tlfInstalador'), document.getElementById('tlfInstaladorError'), 'Introduce un número de teléfono válido (9 dígitos o con prefijo +34).') && formIsValid;
            formIsValid = validateField(document.getElementById('fechaInstalacion'), document.getElementById('fechaInstalacionError'), 'Selecciona la fecha de instalación.') && formIsValid;
            formIsValid = validateField(document.getElementById('horaInstalacion'), document.getElementById('horaInstalacionError'), 'Selecciona la hora de instalación.') && formIsValid;
            
            // Si el formulario no es válido, detenemos el envío y mostramos un mensaje general.
            if (!formIsValid) {
                formMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700', 'bg-orange-100', 'text-orange-700');
                formMessage.classList.add('bg-red-100', 'text-red-700');
                formMessage.textContent = 'Por favor, corrige los errores en el formulario antes de enviar.';
                formMessage.classList.remove('hidden');
                // Desplazarse al primer error visible
                const firstErrorField = document.querySelector('.input-error');
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return; // Detiene el envío del formulario
            }

            // Si la validación en el cliente pasa, procede con el envío
            formMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-orange-100', 'text-orange-700');
            formMessage.classList.add('bg-blue-100', 'text-blue-700');
            formMessage.textContent = 'Enviando datos... Por favor, espera.';

            const formData = new FormData(form);

            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    body: formData 
                });

                if (response.ok) {
                    const resultText = await response.text();
                    formMessage.classList.remove('bg-blue-100', 'text-blue-700', 'bg-red-100', 'text-red-700', 'bg-orange-100', 'text-orange-700');
                    formMessage.classList.add('bg-green-100', 'text-green-700');
                    formMessage.textContent = '¡Formulario enviado con éxito! Los datos han sido guardados. ';
                    formMessage.classList.remove('hidden');
                    form.reset(); 
                } else {
                    const errorText = await response.text();
                    throw new Error(`Error al enviar el formulario: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Error al enviar el formulario:', error);
                formMessage.classList.remove('bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700', 'bg-orange-100', 'text-orange-700');
                formMessage.classList.add('bg-red-100', 'text-red-700');
                formMessage.textContent = 'Error al enviar el formulario. Por favor, inténtalo de nuevo. Detalle: ' + error.message;
                formMessage.classList.remove('hidden');
            }
        });

        // Autocompletado del código postal y validación en tiempo real (al escribir y al perder el foco)
        codigoPostalInput.addEventListener('input', () => autocompleteAddress(codigoPostalInput, poblacionLocalidadInput, provinciaSelect, document.getElementById('codigoPostalError'), document.getElementById('poblacionLocalidadError'), document.getElementById('provinciaError')));
        codigoPostalInput.addEventListener('blur', () => autocompleteAddress(codigoPostalInput, poblacionLocalidadInput, provinciaSelect, document.getElementById('codigoPostalError'), document.getElementById('poblacionLocalidadError'), document.getElementById('provinciaError')));

        contactoCodigoPostalInput.addEventListener('input', () => autocompleteAddress(contactoCodigoPostalInput, contactoPoblacionLocalidadInput, contactoProvinciaSelect, document.getElementById('contactoCodigoPostalError'), document.getElementById('contactoPoblacionLocalidadError'), document.getElementById('contactoProvinciaError')));
        contactoCodigoPostalInput.addEventListener('blur', () => autocompleteAddress(contactoCodigoPostalInput, contactoPoblacionLocalidadInput, contactoProvinciaSelect, document.getElementById('contactoCodigoPostalError'), document.getElementById('contactoPoblacionLocalidadError'), document.getElementById('contactoProvinciaError')));


        // Añadir escuchadores de eventos para validación en tiempo real (al salir del campo)
        document.querySelectorAll('input:not([type="checkbox"]):not([readonly]), select:not([readonly])').forEach(input => {
            // Excluimos los campos de código postal que ya tienen su propia lógica de input/blur
            if (input.id !== 'codigoPostal' && input.id !== 'contactoCodigoPostal') {
                input.addEventListener('blur', () => {
                    const errorElementId = input.id + 'Error';
                    const errorElement = document.getElementById(errorElementId);
                    if (errorElement) { // Asegurarse de que el div de error exista
                        // Usar el título del input como mensaje genérico, o un mensaje predeterminado si es un select
                        const customMessage = input.tagName === 'SELECT' ? 'Por favor, selecciona una opción.' : input.title;
                        validateField(input, errorElement, customMessage);
                    }
                });
            }
        });
    </script>
</body>
</html>
