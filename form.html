<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Datos de Instalación</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Color de fondo suave */
        }
        /* Estilo para campos readonly */
        input[readonly], select[readonly] {
            background-color: #e2e8f0; /* bg-gray-200 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-10 border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 text-center">Datos de Instalación</h1>
        <p class="text-gray-600 mb-8 text-center">Por favor, rellena todos los campos requeridos para la instalación.</p>

        <!-- El atributo 'action' se gestionará con JavaScript (fetch) -->
        <!-- El atributo 'method' se gestionará con JavaScript (fetch) -->
        <form id="installationForm">
            <!-- Sección: Dirección completa de instalación -->
            <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Dirección Completa de Instalación</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tipoVia" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Vía</label>
                        <select id="tipoVia" name="tipoVia" required
                                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                            <option value="">Selecciona</option>
                            <option value="calle">Calle</option>
                            <option value="avenida">Avenida</option>
                            <option value="plaza">Plaza</option>
                            <option value="paseo">Paseo</option>
                            <option value="carretera">Carretera</option>
                            <option value="via">Vía</option>
                            <option value="ronda">Ronda</option>
                            <option value="bulevar">Bulevar</option>
                            <option value="camino">Camino</option>
                            <option value="urbanizacion">Urbanización</option>
                            <option value="glorieta">Glorieta</option>
                            <option value="pasaje">Pasaje</option>
                            <option value="rambla">Rambla</option>
                            <option value="travesia">Travesía</option>
                            <option value="cuesta">Cuesta</option>
                            <option value="barrio">Barrio</option>
                            <option value="poligono">Polígono Industrial</option>
                        </select>
                    </div>
                    <div>
                        <label for="nombreVia" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Vía</label>
                        <input type="text" id="nombreVia" name="nombreVia" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="numero" class="block text-sm font-medium text-gray-700 mb-1">Número</label>
                        <input type="text" id="numero" name="numero" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="bloquePortal" class="block text-sm font-medium text-gray-700 mb-1">Bloque / Portal</label>
                        <input type="text" id="bloquePortal" name="bloquePortal" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <!-- Campo para Código Postal -->
                    <div>
                        <label for="codigoPostal" class="block text-sm font-medium text-gray-700 mb-1">Código Postal</label>
                        <input type="text" id="codigoPostal" name="codigoPostal" required maxlength="5" pattern="[0-9]{5}" title="Introduce un código postal de 5 dígitos"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="poblacionLocalidad" class="block text-sm font-medium text-gray-700 mb-1">Población / Localidad</label>
                        <input type="text" id="poblacionLocalidad" name="poblacionLocalidad" required readonly
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="provincia" class="block text-sm font-medium text-gray-700 mb-1">Provincia</label>
                        <select id="provincia" name="provincia" required readonly
                                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                            <option value="">Selecciona una provincia</option>
                            <option value="Alava">Álava</option>
                            <option value="Albacete">Albacete</option>
                            <option value="Alicante">Alicante</option>
                            <option value="Almeria">Almería</option>
                            <option value="Asturias">Asturias</option>
                            <option value="Avila">Ávila</option>
                            <option value="Badajoz">Badajoz</option>
                            <option value="Barcelona">Barcelona</option>
                            <option value="Burgos">Burgos</option>
                            <option value="Caceres">Cáceres</option>
                            <option value="Cadiz">Cádiz</option>
                            <option value="Cantabria">Cantabria</option>
                            <option value="Castellon">Castellón</option>
                            <option value="Ciudad Real">Ciudad Real</option>
                            <option value="Cordoba">Córdoba</option>
                            <option value="Cuenca">Cuenca</option>
                            <option value="Gerona">Gerona</option>
                            <option value="Granada">Granada</option>
                            <option value="Guadalajara">Guadalajara</option>
                            <option value="Guipuzcoa">Guipúzcoa</option>
                            <option value="Huelva">Huelva</option>
                            <option value="Huesca">Huesca</option>
                            <option value="Islas Baleares">Islas Baleares</option>
                            <option value="Jaen">Jaén</option>
                            <option value="La Coruna">La Coruña</option>
                            <option value="La Rioja">La Rioja</option>
                            <option value="Las Palmas">Las Palmas</option>
                            <option value="Leon">León</option>
                            <option value="Lerida">Lérida</option>
                            <option value="Lugo">Lugo</option>
                            <option value="Madrid">Madrid</option>
                            <option value="Malaga">Málaga</option>
                            <option value="Murcia">Murcia</option>
                            <option value="Navarra">Navarra</option>
                            <option value="Orense">Orense</option>
                            <option value="Palencia">Palencia</option>
                            <option value="Pontevedra">Pontevedra</option>
                            <option value="Salamanca">Salamanca</option>
                            <option value="Santa Cruz de Tenerife">Santa Cruz de Tenerife</option>
                            <option value="Segovia">Segovia</option>
                            <option value="Sevilla">Sevilla</option>
                            <option value="Soria">Soria</option>
                            <option value="Tarragona">Tarragona</option>
                            <option value="Teruel">Teruel</option>
                            <option value="Toledo">Toledo</option>
                            <option value="Valencia">Valencia</option>
                            <option value="Valladolid">Valladolid</option>
                            <option value="Vizcaya">Vizcaya</option>
                            <option value="Zamora">Zamora</option>
                            <option value="Zaragoza">Zaragoza</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sección: Datos de la comunidad de propietarios / empresa -->
            <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200">
                <h2 class="text-2xl font-semibold text-green-700 mb-4">Datos de la Comunidad de Propietarios / Empresa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="denominacionNombre" class="block text-sm font-medium text-gray-700 mb-1">Denominación / Nombre (presidente)</label>
                        <input type="text" id="denominacionNombre" name="denominacionNombre" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="cif" class="block text-sm font-medium text-gray-700 mb-1">C.I.F.</label>
                        <!-- Validación CIF/NIF básico: 1 letra, 7-8 dígitos, 1 letra/dígito final -->
                        <input type="text" id="cif" name="cif" required pattern="^[XYZxyz]?[0-9]{7}[A-HJ-NP-TV-Z]$|^[A-HJ-NP-TV-Z][0-9]{7}[A-Z0-9]$" title="Formato CIF/NIF: ej. A12345678, X12345678"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm uppercase">
                    </div>
                </div>
            </div>

            <!-- Sección: Datos de contacto a efectos administrativos y de facturación -->
            <div class="mb-8 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Datos de Contacto (Administrativos y Facturación)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="contactoAAFF" class="block text-sm font-medium text-gray-700 mb-1">AAFF o Persona de Contacto</label>
                        <input type="text" id="contactoAAFF" name="contactoAAFF" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="emailContacto" class="block text-sm font-medium text-gray-700 mb-1">Email de Contacto</label>
                        <input type="email" id="emailContacto" name="emailContacto" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                    </div>
                </div>
                <!-- Campos detallados de la dirección de contacto -->
                <div class="mt-6 p-4 bg-yellow-100 rounded-md border border-yellow-300">
                    <h3 class="lg font-medium text-yellow-800 mb-3">Dirección Completa de Contacto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contactoTipoVia" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Vía (Contacto)</label>
                            <select id="contactoTipoVia" name="contactoTipoVia" required
                                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                                <option value="">Selecciona</option>
                                <option value="calle">Calle</option>
                                <option value="avenida">Avenida</option>
                                <option value="plaza">Plaza</option>
                                <option value="paseo">Paseo</option>
                                <option value="carretera">Carretera</option>
                                <option value="via">Vía</option>
                                <option value="ronda">Ronda</option>
                                <option value="bulevar">Bulevar</option>
                                <option value="camino">Camino</option>
                                <option value="urbanizacion">Urbanización</option>
                                <option value="glorieta">Glorieta</option>
                                <option value="pasaje">Pasaje</option>
                                <option value="rambla">Rambla</option>
                                <option value="travesia">Travesía</option>
                                <option value="cuesta">Cuesta</option>
                                <option value="barrio">Barrio</option>
                                <option value="poligono">Polígono Industrial</option>
                            </select>
                        </div>
                        <div>
                            <label for="contactoNombreVia" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Vía (Contacto)</label>
                            <input type="text" id="contactoNombreVia" name="contactoNombreVia" required
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="contactoNumero" class="block text-sm font-medium text-gray-700 mb-1">Número (Contacto)</label>
                            <input type="text" id="contactoNumero" name="contactoNumero" required
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="contactoBloquePortal" class="block text-sm font-medium text-gray-700 mb-1">Bloque / Portal (Contacto)</label>
                            <input type="text" id="contactoBloquePortal" name="contactoBloquePortal" required
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <!-- Nuevo campo para Código Postal (Contacto) -->
                        <div>
                            <label for="contactoCodigoPostal" class="block text-sm font-medium text-gray-700 mb-1">Código Postal (Contacto)</label>
                            <input type="text" id="contactoCodigoPostal" name="contactoCodigoPostal" required maxlength="5" pattern="[0-9]{5}" title="Introduce un código postal de 5 dígitos"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="contactoPoblacionLocalidad" class="block text-sm font-medium text-gray-700 mb-1">Población / Localidad (Contacto)</label>
                            <input type="text" id="contactoPoblacionLocalidad" name="contactoPoblacionLocalidad" required readonly
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="contactoProvincia" class="block text-sm font-medium text-gray-700 mb-1">Provincia (Contacto)</label>
                            <select id="contactoProvincia" name="contactoProvincia" required readonly
                                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm transition duration-150 ease-in-out appearance-none">
                                <option value="">Selecciona una provincia</option>
                                <option value="Alava">Álava</option>
                                <option value="Albacete">Albacete</option>
                                <option value="Alicante">Alicante</option>
                                <option value="Almeria">Almería</option>
                                <option value="Asturias">Asturias</option>
                                <option value="Avila">Ávila</option>
                                <option value="Badajoz">Badajoz</option>
                                <option value="Barcelona">Barcelona</option>
                                <option value="Burgos">Burgos</option>
                                <option value="Caceres">Cáceres</option>
                                <option value="Cadiz">Cádiz</option>
                                <option value="Cantabria">Cantabria</option>
                                <option value="Castellon">Castellón</option>
                                <option value="Ciudad Real">Ciudad Real</option>
                                <option value="Cordoba">Córdoba</option>
                                <option value="Cuenca">Cuenca</option>
                                <option value="Gerona">Gerona</option>
                                <option value="Granada">Granada</option>
                                <option value="Guadalajara">Guadalajara</option>
                                <option value="Guipuzcoa">Guipúzcoa</option>
                                <option value="Huelva">Huelva</option>
                                <option value="Huesca">Huesca</option>
                                <option value="Islas Baleares">Islas Baleares</option>
                                <option value="Jaen">Jaén</option>
                                <option value="La Coruna">La Coruña</option>
                                <option value="La Rioja">La Rioja</option>
                                <option value="Las Palmas">Las Palmas</option>
                                <option value="Leon">León</option>
                                <option value="Lerida">Lérida</option>
                                <option value="Lugo">Lugo</option>
                                <option value="Madrid">Madrid</option>
                                <option value="Malaga">Málaga</option>
                                <option value="Murcia">Murcia</option>
                                <option value="Navarra">Navarra</option>
                                <option value="Orense">Orense</option>
                                <option value="Palencia">Palencia</option>
                                <option value="Pontevedra">Pontevedra</option>
                                <option value="Salamanca">Salamanca</option>
                                <option value="Santa Cruz de Tenerife">Santa Cruz de Tenerife</option>
                                <option value="Segovia">Segovia</option>
                                <option value="Sevilla">Sevilla</option>
                                <option value="Soria">Soria</option>
                                <option value="Tarragona">Tarragona</option>
                                <option value="Teruel">Teruel</option>
                                <option value="Toledo">Toledo</option>
                                <option value="Valencia">Valencia</option>
                                <option value="Valladolid">Valladolid</option>
                                <option value="Vizcaya">Vizcaya</option>
                                <option value="Zamora">Zamora</option>
                                <option value="Zaragoza">Zaragoza</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-yellow-100 rounded-md border border-yellow-300">
                    <h3 class="lg font-medium text-yellow-800 mb-3">Datos Bancarios (SEPA)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="titularCuenta" class="block text-sm font-medium text-gray-700 mb-1">Titular de la Cuenta</label>
                            <input type="text" id="titularCuenta" name="titularCuenta" required
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="banco" class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
                            <input type="text" id="banco" name="banco" required
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="iban" class="block text-sm font-medium text-gray-700 mb-1">IBAN</label>
                            <!-- Validación IBAN España: ES + 2 dígitos + 20 alfanuméricos -->
                            <input type="text" id="iban" name="iban" required pattern="^[A-Z]{2}[0-9]{2}(?:[ ]?[0-9]{4}){4}(?:[ ]?[0-9]{2})?$" title="Formato IBAN: ESXX XXXX XXXX XXXX XXXX XXXX (con o sin espacios)"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm placeholder-gray-400"
                                   placeholder="ESXX XXXX XXXX XXXX XXXX XXXX">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Datos del instalador y fecha de instalación -->
            <div class="mb-8 p-6 bg-purple-50 rounded-lg border border-purple-200">
                <h2 class="text-2xl font-semibold text-purple-700 mb-4">Información del Instalador y Cita</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="tlfInstalador" class="block text-sm font-medium text-gray-700 mb-1">Nº de Teléfono del Instalador</label>
                        <!-- Validación para número de teléfono español (9 dígitos, opcionalmente con prefijo +34) -->
                        <input type="tel" id="tlfInstalador" name="tlfInstalador" required pattern="^(\+34|0034)?[6789]\d{8}$" title="Formato de teléfono: 9 dígitos (ej. 6XXXXXXXX) o con +34"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="fechaInstalacion" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Instalación</label>
                        <input type="date" id="fechaInstalacion" name="fechaInstalacion" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="horaInstalacion" class="block text-sm font-medium text-gray-700 mb-1">Hora de Instalación</label>
                        <input type="time" id="horaInstalacion" name="horaInstalacion" required
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <div class="flex items-center">
                            <!-- Checkbox ya no es obligatorio -->
                            <input id="normoApp" name="normoApp" type="checkbox"
                                   class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <label for="normoApp" class="ml-2 block text-sm font-medium text-gray-700">El instalador se ha descargado y registrado en la app de Normo</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área para mostrar mensajes de confirmación o error -->
            <div id="formMessage" class="mt-4 p-3 rounded-md text-center hidden"></div>

            <!-- Botón de Envío -->
            <div class="mt-10 text-center">
                <button type="submit"
                        class="inline-flex justify-center py-3 px-8 border border-transparent shadow-sm text-lg font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105">
                    Enviar Formulario
                </button>
            </div>
        </form>
    </div>

    <script>
        // ¡IMPORTANTE! Reemplaza esta URL con la URL de tu Web App de Google Apps Script
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzPx0diQcFHQ9fPxUXDqY91_Lceq9UhbRNwO0SZzQh8KGsx2URvBlpe4YO-sgSbAcD/exec'; 

        const form = document.getElementById('installationForm');
        const formMessage = document.getElementById('formMessage');

        // Referencias a los campos de Código Postal y sus respectivos campos de Población/Provincia
        const codigoPostalInput = document.getElementById('codigoPostal');
        const poblacionLocalidadInput = document.getElementById('poblacionLocalidad');
        const provinciaSelect = document.getElementById('provincia');

        const contactoCodigoPostalInput = document.getElementById('contactoCodigoPostal');
        const contactoPoblacionLocalidadInput = document.getElementById('contactoPoblacionLocalidad');
        const contactoProvinciaSelect = document.getElementById('contactoProvincia');

        /**
         * Función para obtener datos de población y provincia por código postal usando Nominatim.
         * @param {string} postalCode - El código postal de 5 dígitos.
         * @returns {Promise<Object>} - Un objeto con { success: boolean, ciudad: string, provincia: string, message: string }
         */
        async function fetchPostalCodeData(postalCode) {
            // URL de la API de Nominatim para buscar por código postal y país (España)
            // Se usa "es" para el lenguaje de la respuesta.
            const NOMINATIM_URL = `https://nominatim.openstreetmap.org/search?postalcode=${postalCode}&country=Spain&format=json&addressdetails=1&limit=1&accept-language=es`;
            
            try {
                const response = await fetch(NOMINATIM_URL, {
                    headers: {
                        // User-Agent es requerido por Nominatim para un uso adecuado
                        // Reemplaza 'tu-email@ejemplo.com' con un email real o un identificador único
                        'User-Agent': 'FormularioInstalacionApp/1.0 (tu-email@ejemplo.com)' 
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0].address;
                    let ciudad = '';
                    let provincia = '';

                    // Intentar extraer ciudad y provincia de la respuesta de Nominatim
                    // Nominatim puede devolver la provincia en 'state' o 'county'
                    // Para España, 'state' suele ser la comunidad autónoma, y 'county' o 'province' la provincia
                    // Ajustamos la lógica para buscar por nombres comunes de provincias españolas
                    
                    ciudad = result.city || result.town || result.village || result.county;
                    provincia = result.state || result.county || result.province; // Buscar en varios campos

                    // Pequeño mapeo para algunas provincias que Nominatim podría devolver de forma genérica
                    const provinceMapping = {
                        'comunidad de madrid': 'Madrid',
                        'comunitat valenciana': 'Valencia', // Podría ser Valencia, Alicante, Castellón
                        'cataluña': 'Barcelona', // Podría ser Barcelona, Girona, Lleida, Tarragona
                        'andalucía': 'Sevilla', // Etc.
                        'país vasco': 'Vizcaya', // O Álava, Guipúzcoa
                        // Añade más mapeos si encuentras inconsistencias
                    };

                    // Normalizar y aplicar mapeo
                    const normalizeText = (text) => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
                    const normalizedProvincia = normalizeText(provincia);

                    if (provinceMapping[normalizedProvincia]) {
                        provincia = provinceMapping[normalizedProvincia];
                    } else {
                        // Si no hay mapeo, intenta usar el nombre tal cual, capitalizando la primera letra
                        provincia = provincia.charAt(0).toUpperCase() + provincia.slice(1);
                    }

                    if (ciudad && provincia) {
                        console.log(`Datos de Nominatim para CP ${postalCode}: Ciudad '${ciudad}', Provincia '${provincia}'`); // Para depuración
                        return { success: true, ciudad: ciudad, provincia: provincia };
                    } else {
                        return { success: false, message: 'Datos de población/provincia incompletos para este CP. Por favor, rellena manualmente.' };
                    }
                } else {
                    return { success: false, message: 'Código postal no encontrado en España. Por favor, introduce manualmente.' };
                }
            } catch (error) {
                console.error('Error al consultar la API de Nominatim:', error);
                return { success: false, message: 'Error al conectar con el servicio de códigos postales. Intenta de nuevo más tarde.' };
            }
        }

        /**
         * Autocompleta los campos de población y provincia basándose en el código postal.
         * @param {HTMLElement} postalCodeInput - El input del código postal.
         * @param {HTMLElement} poblacionInput - El input de la población/localidad.
         * @param {HTMLElement} provinciaSelect - El select de la provincia.
         */
        async function autocompleteAddress(postalCodeInput, poblacionInput, provinciaSelect) {
            const postalCode = postalCodeInput.value.trim();

            // Limpia los campos si el CP está vacío o es inválido
            if (postalCode.length !== 5 || !/^[0-9]{5}$/.test(postalCode)) {
                poblacionInput.value = '';
                provinciaSelect.value = '';
                // Habilitar selección manual si el CP es inválido
                poblacionInput.readOnly = false;
                provinciaSelect.readOnly = false;
                return;
            }

            // Deshabilitar campos mientras se busca
            poblacionInput.readOnly = true;
            provinciaSelect.readOnly = true;
            poblacionInput.value = 'Buscando...';
            // provinciaSelect.value = ''; // No limpiar completamente para mantener la opción 'Selecciona una provincia'

            try {
                const data = await fetchPostalCodeData(postalCode); 
                if (data.success) {
                    poblacionInput.value = data.ciudad;
                    
                    // Normalizar el nombre de provincia de la API para la comparación
                    const normalizedDataProvincia = data.provincia.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

                    let optionFound = false;
                    Array.from(provinciaSelect.options).forEach(option => {
                        const normalizedOption = option.value.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                        if (normalizedOption === normalizedDataProvincia) {
                            provinciaSelect.value = option.value; // Establece el valor exacto de la opción
                            optionFound = true;
                        }
                    });
                    
                    if (!optionFound) {
                        console.warn(`Provincia '${data.provincia}' obtenida de la API no encontrada en la lista de opciones del select.`);
                        // Si no se encuentra una coincidencia exacta, se queda la opción por defecto o vacía
                        provinciaSelect.value = ''; 
                    }
                    poblacionInput.readOnly = true; // Mantener readonly si se encontró
                    provinciaSelect.readOnly = true; // Mantener readonly si se encontró

                } else {
                    poblacionInput.value = '';
                    provinciaSelect.value = '';
                    // Mostrar mensaje de error en la UI
                    formMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700');
                    formMessage.classList.add('bg-orange-100', 'text-orange-700'); // Color para advertencia
                    formMessage.textContent = data.message; // Mensaje de error más específico de la función
                    formMessage.classList.remove('hidden');
                    // Habilitar campos para entrada manual si no se encontró
                    poblacionInput.readOnly = false;
                    provinciaSelect.readOnly = false;
                }
            } catch (error) {
                console.error('Error general al obtener datos del código postal:', error);
                poblacionInput.value = '';
                provinciaSelect.value = '';
                formMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700');
                formMessage.classList.add('bg-red-100', 'text-red-700');
                formMessage.textContent = 'Error de red o servicio de CP. Por favor, inténtalo de nuevo o rellena manualmente.';
                formMessage.classList.remove('hidden');
            } finally {
                // La lógica de readOnly ahora se gestiona dentro del if/else de data.success
            }
        }

        // Añadir escuchadores de eventos para el Código Postal de Instalación
        codigoPostalInput.addEventListener('input', () => {
            // Solo buscar si el CP tiene 5 dígitos
            if (codigoPostalInput.value.trim().length === 5) {
                autocompleteAddress(codigoPostalInput, poblacionLocalidadInput, provinciaSelect);
            } else {
                poblacionLocalidadInput.value = '';
                provinciaSelect.value = '';
                poblacionLocalidadInput.readOnly = false;
                provinciaSelect.readOnly = false;
                formMessage.classList.add('hidden'); // Ocultar mensaje si el CP es corto
            }
        });

        // Añadir escuchadores de eventos para el Código Postal de Contacto
        contactoCodigoPostalInput.addEventListener('input', () => {
            // Solo buscar si el CP tiene 5 dígitos
            if (contactoCodigoPostalInput.value.trim().length === 5) {
                autocompleteAddress(contactoCodigoPostalInput, contactoPoblacionLocalidadInput, contactoProvinciaSelect);
            } else {
                contactoPoblacionLocalidadInput.value = '';
                contactoProvinciaSelect.value = '';
                contactoPoblacionLocalidadInput.readOnly = false;
                contactoProvinciaSelect.readOnly = false;
                formMessage.classList.add('hidden'); // Ocultar mensaje si el CP es corto
            }
        });


        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Previene el envío tradicional del formulario

            // Oculta cualquier mensaje anterior y muestra uno de carga
            formMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-orange-100', 'text-orange-700');
            formMessage.classList.add('bg-blue-100', 'text-blue-700');
            formMessage.textContent = 'Enviando datos... Por favor, espera.';

            const formData = new FormData(form);

            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    body: formData // Envía los datos directamente como FormData
                });

                if (response.ok) {
                    const resultText = await response.text(); // El script de Apps Script devuelve texto
                    formMessage.classList.remove('bg-blue-100', 'text-blue-700', 'bg-red-100', 'text-red-700', 'bg-orange-100', 'text-orange-700');
                    formMessage.classList.add('bg-green-100', 'text-green-700');
                    formMessage.textContent = '¡Formulario enviado con éxito! Los datos han sido guardados. ' + resultText;
                    formMessage.classList.remove('hidden');
                    form.reset(); // Limpia los campos del formulario
                } else {
                    const errorText = await response.text();
                    throw new Error(`Error al enviar el formulario: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Error al enviar el formulario:', error);
                formMessage.classList.remove('bg-blue-100', 'text-blue-700', 'bg-green-100', 'text-green-700', 'bg-orange-100', 'text-orange-700');
                formMessage.classList.add('bg-red-100', 'text-red-700');
                formMessage.textContent = 'Error al enviar el formulario. Por favor, inténtalo de nuevo. Detalle: ' + error.message;
                formMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
